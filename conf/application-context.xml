<beans xmlns="http://www.springframework.org/schema/beans"
   xmlns:context="http://www.springframework.org/schema/context"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:mvc="http://www.springframework.org/schema/mvc"
   xsi:schemaLocation="
        http://www.springframework.org/schema/beans     
        http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
        http://www.springframework.org/schema/context 
        http://www.springframework.org/schema/context/spring-context-3.0.xsd
        http://www.springframework.org/schema/mvc
        http://www.springframework.org/schema/mvc/spring-mvc.xsd">

    <bean id="bridgeConfig" class="org.sagebionetworks.bridge.config.BridgeConfigFactory"
            factory-method="getConfig" />

    <bean id="healthCodeEncryptor" class="org.sagebionetworks.bridge.crypto.BridgeEncryptor">
        <constructor-arg value="#{bridgeConfig.healthCodePassword}"/>
    </bean>

    <bean id="awsCredentials" class="com.amazonaws.auth.BasicAWSCredentials">
        <constructor-arg index="0" value="#{bridgeConfig.getProperty('aws.key')}"/>
        <constructor-arg index="1" value="#{bridgeConfig.getProperty('aws.secret.key')}"/>
    </bean>

    <!-- DynamoDB -->

    <bean id="dynamoDbClient" class="com.amazonaws.services.dynamodbv2.AmazonDynamoDBClient">
        <constructor-arg index="0">
            <ref bean="awsCredentials" />
        </constructor-arg>
    </bean>

    <bean id="healthCodeDao" class="org.sagebionetworks.bridge.dynamodb.DynamoHealthCodeDao">
        <property name="dynamoDbClient" ref="dynamoDbClient" />
    </bean>

    <bean id="healthIdDao" class="org.sagebionetworks.bridge.dynamodb.DynamoHealthIdDao">
        <property name="dynamoDbClient" ref="dynamoDbClient" />
    </bean>

    <bean id="exceptionInterceptor" class="interceptors.ExceptionInterceptor" />

    <!-- Stormpath identity service -->

    <bean id="stormpathClient" class="org.sagebionetworks.bridge.stormpath.StormpathFactory" 
        factory-method="createStormpathClient" scope="singleton">
    </bean>

    <!-- Caching abstraction -->

    <bean id="cacheProvider" class="org.sagebionetworks.bridge.cache.CacheProvider"/>

    <!-- Play controllers. -->

    <bean id="proxiedController" class="org.springframework.aop.framework.ProxyFactoryBean">
        <property name="proxyTargetClass" value="true"/>
        <property name="interceptorNames">
            <list><value>exceptionInterceptor</value></list>
        </property>
    </bean>

    <bean id="controllers.ApplicationController" parent="proxiedController">
        <property name="target">
            <bean class="controllers.ApplicationController">
                <property name="authenticationService" ref="authenticationService" />
                <property name="studyControllerService" ref="studyControllerService"/>
            </bean>
        </property>
    </bean>

    <bean id="controllers.AuthenticationController" parent="proxiedController">
        <property name="target">
            <bean class="controllers.AuthenticationController">
                <property name="authenticationService" ref="authenticationService"/>
                <property name="studyControllerService" ref="studyControllerService"/>
            </bean>
        </property>
    </bean>
 
    <bean id="controllers.HealthDataController" parent="proxiedController">
        <property name="target">
            <bean class="controllers.HealthDataController">
                <property name="healthDataService" ref="healthDataService"/>
                <property name="authenticationService" ref="authenticationService"/>
                <property name="studyControllerService" ref="studyControllerService"/>
            </bean>
        </property>
    </bean>

    <bean id="controllers.TrackerController" parent="proxiedController">
        <property name="target">
            <bean class="controllers.TrackerController">
                <property name="jsonSchemaValidator">
                    <bean class="global.JsonSchemaValidator"/>
                </property>
                <property name="studyControllerService" ref="studyControllerService"/>
                <property name="authenticationService" ref="authenticationService"/>
            </bean>
        </property>
    </bean>

    <bean id="controllers.UserProfileController" parent="proxiedController">
        <property name="target">
            <bean class="controllers.UserProfileController">
                <property name="authenticationService" ref="authenticationService"/>
                <property name="cacheProvider" ref="cacheProvider"/>
                <property name="userProfileService" ref="userProfileService"/>
            </bean>
        </property>
    </bean>
    
    <bean id="controllers.BackfillController" parent="proxiedController">
        <property name="target">
            <bean class="controllers.BackfillController">
                <property name="authenticationService" ref="authenticationService" />
                <property name="stormpathClient" ref="stormpathClient" />
                <property name="healthCodeBackfill" ref="healthCodeBackfill" />
            </bean>
        </property>
    </bean>

    <bean id="studyControllerService" class="controllers.StudyControllerService">
        <property name="studies">
            <list>
                <bean class="org.sagebionetworks.bridge.models.Study">
                    <constructor-arg index="0" value="Parkinsonâ€™s Disease Mobile Study"/>
                    <constructor-arg index="1" value="neurod"/>
                    <constructor-arg index="2">
                        <list>
                            <!-- IE VirtualBox Machine, local development -->
                            <value>10.0.2.2</value>
                            <value>localhost</value>
                            <value>bridge-develop.herokuapp.com</value>
                            <!-- In production however, we'd expect to have DNS
                                entries like neurod.bridgesage.org, that we 
                                would use instead.
                             -->
                            <value>bridge-prod.herokuapp.com</value>
                        </list>
                    </constructor-arg>
                    <constructor-arg index="3">
                        <list>
                            <ref bean="pb-tracker"/>
                            <ref bean="med-tracker"/>
                        </list>
                    </constructor-arg>                    
                </bean>
            </list>
        </property>
    </bean>

    <bean id="pb-tracker" class="org.sagebionetworks.bridge.models.Tracker">
        <property name="name" value="Blood Pressure Reading"/>
        <property name="type" value="BloodPressure"/>
        <property name="id" value="1"/>
        <property name="schemaFile" value="file:conf/schemas/bloodpressure.json"/>
    </bean>

    <bean id="med-tracker" class="org.sagebionetworks.bridge.models.Tracker">
        <property name="name" value="Medication"/>
        <property name="type" value="Medication"/>
        <property name="id" value="2"/>
        <property name="schemaFile" value="file:conf/schemas/medication.json"/>
    </bean>

    <!-- Services -->

    <bean id="healthCodeService" class="org.sagebionetworks.bridge.services.HealthCodeServiceImpl">
        <property name="healthIdDao" ref="healthIdDao" />
        <property name="healthCodeDao" ref="healthCodeDao" />
    </bean>

    <bean id="authenticationService" class="org.sagebionetworks.bridge.services.AuthenticationServiceImpl">
        <property name="stormpathClient" ref="stormpathClient"/>
        <property name="cacheProvider" ref="cacheProvider"/>
        <property name="bridgeConfig" ref="bridgeConfig"/>
        <property name="healthCodeEncryptor" ref="healthCodeEncryptor" />
        <property name="healthCodeService" ref="healthCodeService" />
        <property name="userProfileService" ref="userProfileService" />
    </bean>

    <bean id="healthDataService" class="org.sagebionetworks.bridge.services.HealthDataServiceImpl">
        <property name="updateMapper">
            <bean class="com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBMapper">
                <constructor-arg index="0" ref="dynamoDbClient"/>
                <constructor-arg index="1">
                    <bean class="org.sagebionetworks.bridge.dynamodb.DynamoDBMapperConfigFactory" factory-method="getUpdateMapper">
                        <constructor-arg><value>org.sagebionetworks.bridge.dynamodb.DynamoHealthDataRecord</value></constructor-arg>
                    </bean>
                </constructor-arg>
            </bean>
        </property>
        <property name="createMapper">
            <bean class="com.amazonaws.services.dynamodbv2.datamodeling.DynamoDBMapper">
                <constructor-arg index="0" ref="dynamoDbClient"/>
                <constructor-arg index="1">
                    <bean class="org.sagebionetworks.bridge.dynamodb.DynamoDBMapperConfigFactory" factory-method="getCreateMapper">
                        <constructor-arg><value>org.sagebionetworks.bridge.dynamodb.DynamoHealthDataRecord</value></constructor-arg>
                    </bean>
                </constructor-arg>
            </bean>
        </property>
        <property name="cacheProvider" ref="cacheProvider"/>
    </bean>
    
    <bean id="userProfileService" class="org.sagebionetworks.bridge.services.UserProfileServiceImpl">
        <property name="stormpathClient" ref="stormpathClient" />
    </bean>

    <!-- Backfill -->
    <bean id="healthCodeBackfill" class="org.sagebionetworks.bridge.backfill.HealthCodeBackfill">
        <property name="bridgeConfig" ref="bridgeConfig" />
        <property name="stormpathClient" ref="stormpathClient"/>
        <property name="studyControllerService" ref="studyControllerService" />
        <property name="healthCodeEncryptor" ref="healthCodeEncryptor" />
        <property name="healthCodeService" ref="healthCodeService" />
    </bean>
</beans>
